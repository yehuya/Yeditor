<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test frontend-editor</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container-fluid text-center">
        <h1>
            Lorem Ipsum
        </h1>
    </div>
    <div class="container-fluid">
        <div class="col-xs-4 text-left">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec ipsum quam, sollicitudin at dictum vel, congue quis purus.
            Praesent interdum fringilla urna, vitae lacinia neque placerat sed. Ut dignissim magna nec tellus euismod
            porta. In mollis enim ut erat pulvinar, rhoncus semper mi convallis. Duis vehicula orci non enim convallis
            placerat. Maecenas tincidunt urna id nisl aliquam accumsan. Integer tellus mi, laoreet eu neque sit amet,
            consectetur lacinia velit. Suspendisse hendrerit vestibulum nibh. Vivamus convallis tortor urna, sit amet
            lobortis magna porta ut. Quisque a mattis arcu. Maecenas est nulla, pharetra eget felis vitae, facilisis
            vestibulum ex. Praesent a enim sit amet erat pretium lobortis. Nullam blandit nisi nulla, id tempus dolor
            placerat nec. Etiam dui massa, imperdiet euismod nulla ut, mattis dapibus leo. Suspendisse non orci elementum,
            pellentesque neque vitae, dignissim tellus.
        </div>
        <div class="col-xs-4 text-left">
            Etiam hendrerit in nisi vel fermentum. Duis vel ligula elit. Etiam id lobortis mi. Vestibulum ultricies maximus odio, quis
            <img class="pull-right" id="img" src="images/tmp.jpg" /> vulputate lacus laoreet eget. Donec aliquam sem nisl, non
            dictum est feugiat sit amet. Fusce viverra, sapien aliquet vulputate aliquam, metus lectus elementum tellus,
            nec facilisis nibh libero vel ipsum. Sed laoreet porta sapien non suscipit. Nam sed tellus ut urna posuere
            rhoncus. Sed scelerisque vestibulum massa, at imperdiet est tincidunt quis.
        </div>
        <div class="col-xs-4 text-left">
            Sed in erat lectus. In pretium ligula nec nunc fringilla gravida. Nulla facilisi. Ut dignissim justo sed neque tristique
            egestas. Etiam tristique neque ullamcorper, pellentesque quam ut, tincidunt lectus. In sit amet ipsum eget
            libero sodales suscipit eu accumsan odio. Quisque lorem nisl, iaculis ac accumsan ut, luctus condimentum
            orci. <span style="color:blue;" id="parent"> orem nisl odio <span style="color:green;" id="child">Aenea</span> condimentumn dolor</span>, condimentum et nibh id, pulvinar consequat arcu. Sed non risus sem. Mauris risus
            ligula, molestie sed arcu a, feugiat hendrerit eros. Ut posuere, ex vel lobortis suscipit, justo turpis auctor
            nulla, a sollicitudin nibh sem faucibus arcu. Suspendisse vitae porttitor sapien.
        </div>
    </div>
    <input id="uploadImage" type="file" accept="image/*">

    <script src="../dist/index.bundle.js"></script>
    <script>
        var title = document.getElementsByTagName('h1')[0];
        var edit = title.editable({
            name: 'title'
        });

        var text = document.getElementsByClassName('col-xs-4');
        for(var i = 0 ; i < text.length ; i++){
            text[i].editable({
                name: 'text-' + i
            });
        }

/**
 * 1. one element: 1 - 1
 * 2. two element, the second in the end: 1, 2
 * 3. one element inside the second: 1, 2, 1
 * 4. multiple element: 1,2,3,4
 * 5. multiple element inside the second element: 1,[1,2,3]
 */

        function run(){
            var range = selection();

            var start = range.startContainer;
            var end = range.endContainer;

            var offset = {start: range.startOffset, end: range.endOffset}

            process(start, end, offset, range);
        }

        function selection(){
            var s = window.getSelection();
            if(s.isCollapsed) return alert('Select some text');
            var range = s.getRangeAt(0);
            s.removeAllRanges();

            return range;
        }

        function process(start, end, offset, range){
            if(end == start){
                // 1
                appendFromTo(start, offset.start, offset.end);
            }else{
                // 2
                appendFromTo(start, offset.start, null);
                appendFromTo(end, null, offset.end);

                var prev = range.endContainer.previousSibling;
                var next = range.startContainer.nextSibling;

                console.log(range, prev, next);
                if(next == prev){
                    // console.log(startSibling);
                    append(next);
                }else{
                    // console.log(startSibling, endSibling);
                    while(next == prev){
                        append(next);
                        next = next.nextSibling;
                    }
                }
            }
        }

        function append(node){
            appendFromTo(node, null, null);
        }  

        function appendFromTo(node, from, to){
            var text = node.textContent;
            var parent = node.parentElement;
            var nextSibling = node.nextSibling;

            if(to == null) to = text.length;
            if(from == null) from = 0;

            var p1 = text.substring(0, from);
            var p2 = text.substring(from, to);
            var p3 = text.substring(to, text.length);

            parent.removeChild(node);

            if(p1.length > 0 ) parent.insertBefore(createTextNode(p1), nextSibling);
            if(p2.length > 0 ) parent.insertBefore(appendTextToSpan(p2), nextSibling);
            if(p3.length > 0 ) parent.insertBefore(createTextNode(p3), nextSibling);             
        }

        function createTextNode(text){
            return document.createTextNode(text).cloneNode(true);
        }

        function appendTextToSpan(text){
            var span = document.createElement('span');
            span.style.fontWeight = 'bold';

            var textNode = createTextNode(text);
            span.appendChild(textNode);

            return span.cloneNode(true)
        }


        // var select = function(){
            // select text in one element
        //     if(start == end){
        //         From(start, sOffset, eOffset);

        //     // select text in two element
        //     }else{
        //         From(start, sOffset, null);
        //         From(end, null, eOffset);
        //     }

        //     // there is element between the selection
        //     if(epreviousSibling == snextSibling){
        //         From(snextSibling,null,null);
        //     }

        //     // there is multiple element in the between selection
        //     if(epreviousSibling != snextSibling){
        //         // var run = snextSibling;
        //         // while(run != epreviousSibling){
        //         //     From(run, null, null);
        //         //     run = run.nextSibling;
        //         // }
        //     }

        //     return range;
        //  }

        //  var Cilderen = function(node){
        //      var childNode = node.firstChild;
        //      if(!childNode);
        //          From(node, null, null);
        //          return;
        //      }

        //      while(childNode){
        //          From(childNode, null, null);
        //          childNode = childNode.nextSibling;
        //      }
        //  }

        //  var createSpan = function(text){
        //      var a = document.createElement('span');
        //      a.style.fontWeight = 'bold';

        //      var b = document.createTextNode(text).cloneNode();
        //      a.appendChild(b);
        //      return a.cloneNode(true);
        //  }

        //  var createTextNode = function(text){
        //      var a = document.createTextNode(text);
        //      return a.cloneNode(true);
        //  }

//##########
        // var input = document.getElementById('uploadImage');
        // input.change(function(event){
        //     var files = event.target.files || event.dataTransfer.files;
        //     console.log(event.target.files);
        //     var reader = new FileReader();

           
        //     for(var i = 0, f; f = files[i]; i++) {
		// 	    reader.onload = (function(file){
        //             return function(event){
        //                 console.log(event);
        //                 // var type = file.type;
        //                 // var result = event.target.result;
        //                 // var clean = result.substring(result.indexOf(',') + 1);
        //                 // var blob = b64toBlob(clean, type);
        //                 // var img = new Image();
        //                 // img.src = result;//window.URL.createObjectURL(blob);
        //                 // document.body.appendChild(img);

        //                 // var a = window.ajax;
        //                 // a.addData('blob', blob);
        //                 // a.request().done(function(xhr){
        //                 //     console.log(xhr)
        //                 // });
        //             }
        //         })(files[0]);
        //         reader.readAsBinaryString(files[0]);
        //         // reader.readAsDataURL(files[0]);
        //     }
        // });

        // function b64toBlob(b64Data, contentType, sliceSize) {
        //     contentType = contentType || '';
        //     sliceSize = sliceSize || 512;

        //     var byteCharacters = atob(b64Data);
        //     var byteArrays = [];

        //     for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        //         var slice = byteCharacters.slice(offset, offset + sliceSize);

        //         var byteNumbers = new Array(slice.length);
        //         for (var i = 0; i < slice.length; i++) {
        //         byteNumbers[i] = slice.charCodeAt(i);
        //         }

        //         console.log(byteNumbers);

        //         var byteArray = new Uint8Array(byteNumbers);
        //         console.log(byteArray);
        //         byteArrays.push(byteArray);
        //     }

        //     var blob = new Blob(byteArrays, {type: contentType});
        //     return blob;
        // }

        //### usefull link convert to base64 into binary
        // http://stackoverflow.com/questions/16245767/creating-a-blob-from-a-base64-string-in-javascript
    </script>
</body>

</html>